<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <title>Covid19 Puzzle</title>

    <!-- Bootstrap core CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <!-- font -->
    <link
      href="https://fonts.googleapis.com/css?family=Raleway"
      rel="stylesheet"
    />

    <!-- Custom styles for this template -->
    <link href="css/puzzle.css" rel="stylesheet" />
  </head>

  <body>
    <!-- Navigation -->
    <div class="container-fluid mt-5">
      <h1 class="title">COVID-19 PUZZLE</h1>

      <div class="row mb-5 mt-5">
        <div class="col-lg-2 my-auto">
          <h3 id="score">Score: 0</h3>
          <div class="w-100 h-100 d-flex justify-content-center">
            <div class="image-preview d-flex align-items-center">
              <div class="d-flex flex-column">
                <img id="picture_preview" class="picture" src="" alt="image" />
                <div class="image-preview-button d-flex">
                  <button
                    id="previous-button"
                    onClick="prevQuestion()"
                    type="button"
                    class="btn btn-primary"
                  >
                    <
                  </button>
                  <button
                    id="next-button"
                    onClick="nextQuestion()"
                    type="button"
                    class="btn btn-primary"
                  >
                    >
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- puzzle image -->
        <div class="col-lg-5 my-auto">
          <div style="text-align: center">
            <div style="">
              <h1 id="message"></h1>
            </div>
            <div style="">
              <h1 id="moves">MOVES: 0</h1>

              <audio
                id="cheers"
                controls="none"
                preload="auto"
                style="display: none"
              >
                <source src="aud.mp3" type="audio/mp3" />
              </audio>

              <audio
                id="cut"
                controls="none"
                preload="auto"
                style="display: none"
              >
                <source src="cut.mp4" type="audio/mp4" />
              </audio>

              <audio
                id="no"
                controls="none"
                preload="auto"
                style="display: none"
              >
                <source src="no.mp4" type="audio/mp4" />
              </audio>
            </div>

            <div class="image-puzzle">
              <!-- <canvas id="canvas" height="450px" width="450px"></canvas> -->
              <div class="tiles">
                <div class="tile img0" style="left: 0px; top: 0px">
                  <img class="picture" />
                </div>
                <div class="tile img1" style="left: 150px; top: 0px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, 0)"
                  />
                </div>
                <div class="tile img2" style="left: 300px; top: 0px">
                  <img
                    class="picture"
                    style="transform: translate(-300px, 0)"
                  />
                </div>
                <div class="tile img3" style="left: 0px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(0, -150px)"
                  />
                </div>
                <div class="tile img4" style="left: 150px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, -150px)"
                  />
                </div>
                <div class="tile img5" style="left: 300px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(-300px, -150px)"
                  />
                </div>
                <div class="tile img6" style="left: 0px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(0, -300px)"
                  />
                </div>
                <div class="tile img7" style="left: 150px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, -300px)"
                  />
                </div>
                <div class="tile img8" style="left: 300px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(-450px, -450px)"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- original image -->
        <div class="col-lg-5 my-auto">
          <div style="text-align: center">
            <div style="">
              <h1 id="message_ai"></h1>
            </div>
            <div style="">
              <h1 id="moves_ai">MOVES: 0</h1>
            </div>

            <div class="image-puzzle">
              <div class="tiles">
                <div class="tile img_ai0" style="left: 0px; top: 0px">
                  <img class="picture" />
                </div>
                <div class="tile img_ai1" style="left: 150px; top: 0px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, 0)"
                  />
                </div>
                <div class="tile img_ai2" style="left: 300px; top: 0px">
                  <img
                    class="picture"
                    style="transform: translate(-300px, 0)"
                  />
                </div>
                <div class="tile img_ai3" style="left: 0px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(0, -150px)"
                  />
                </div>
                <div class="tile img_ai4" style="left: 150px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, -150px)"
                  />
                </div>
                <div class="tile img_ai5" style="left: 300px; top: 150px">
                  <img
                    class="picture"
                    style="transform: translate(-300px, -150px)"
                  />
                </div>
                <div class="tile img_ai6" style="left: 0px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(0, -300px)"
                  />
                </div>
                <div class="tile img_ai7" style="left: 150px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(-150px, -300px)"
                  />
                </div>
                <div class="tile img_ai8" style="left: 300px; top: 300px">
                  <img
                    class="picture"
                    style="transform: translate(-450px, -450px)"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Knowledge Message -->
      <div class="row justify-content-end">
        <div class="col-lg-10">
          <div class="d-flex justify-content-center">
            <div class="w-75 card text-white bg-dark mb-3">
              <div class="card-header">For your information</div>
              <div class="card-body">
                <h5 class="card-title">Lockdown</h5>
                <p class="card-text">
                  Lockdown merupakan kondisi di mana orang-orang tak boleh
                  keluar dan masuk pada suatu daerah.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script src="./algo/search-solution.js"></script>
    <script src="./algo/arr_helper.js"></script>
    <script src="./soal.js"></script>

    <script>
      var normArr = [0, 1, 2, 3, 4, 5, 6, 7, 8];
      var datasCurrInd = 0;
      changeCurrQuestion(0);

      class ImgObj {
        constructor(accessor) {
          this.imgArr = [];
          this.identifier = `img${accessor}`;
          this.zeroPictureId = `img${accessor}8`;
          this.moves = -1;
          this.emptyPos = 9;
          this.restart = 0;
          this.moveId = `moves${accessor}`;
          this.messageId = `message${accessor}`;
          this.score = 0
        }
      }

      var imgObject = new ImgObj("");
      var imgObjectAI = new ImgObj("_ai");

      function nextQuestion() {
        if (datasCurrInd < datas.length - 1) {
          datasCurrInd += 1;
          changeCurrQuestion(datasCurrInd);
        }
      }

      function prevQuestion() {
        if (0 <= datasCurrInd) {
          datasCurrInd -= 1;
          changeCurrQuestion(datasCurrInd);
        }
      }

      function changeCurrQuestion(index) {
        let imageTiles = document.getElementsByClassName("picture");
        let arrImgTiles = [...imageTiles];
        arrImgTiles.forEach((element) => {
          element.src = datas[index].location;
        });

        let cardTitle = document.getElementsByClassName("card-title")[0];
        let cardText = document.getElementsByClassName("card-text")[0];
        cardTitle.innerHTML = datas[index].title
        cardText.innerHTML = datas[index].description

        if (datasCurrInd == datas.length - 1) {
          document.getElementById("next-button").disabled = true;
        } else if (0 <= datasCurrInd) {
          document.getElementById("previous-button").disabled = true;
        }

        if (datasCurrInd > 0) {
          document.getElementById("previous-button").disabled = false;
        }

        if (datasCurrInd < datas.length - 1) {
          document.getElementById("next-button").disabled = false;
        }

      }

      function won() {
        let img = null;
        if (imgObject.restart == 1) {
          imgObject.score++
          showMessage(
            imgObject.messageId,
            "You won the game in " + imgObject.moves.toString() + " moves"
          );
          let score = document.getElementById("score");
          score.innerHTML = "Score: "+imgObject.score
          showMessage(imgObjectAI.messageId, "AI lose");
          imgObjectAI.restart = 1;
          showLastPicture(imgObject.zeroPictureId, 300, 300, -300, -300);
        } else if (imgObjectAI.restart == 1) {
          console.log("AI WIN");
          showMessage(
            imgObjectAI.messageId,
            "AI won the game in " + imgObjectAI.moves.toString() + " moves"
          );
          showMessage(imgObject.messageId, "You lose");
          showLastPicture(imgObjectAI.zeroPictureId, 300, 300, -300, -300);
        }

        au = document.getElementById("cheers");
        au.play();
        imgObject.moves = -1;
        imgObjectAI.moves = -1;
        window.removeEventListener("keydown", addGameControl);
        console.log("finish WON");
      }

      function showLastPicture(pictureId, x, y, xOff, yOff) {
        let imgElement = document.getElementsByClassName(pictureId)[0];
        imgElement.style.top = y + "px";
        imgElement.style.left = x + "px";
        let imgInner = imgElement.childNodes[1];
        imgInner.style.transform = "translate(" + xOff + "px, " + yOff + "px)";
      }

      function showMessage(messageId, message) {
        let messageElement = document.getElementById(messageId);
        messageElement.innerHTML = message;
      }

      // function restartProp(blankImageId) {
      //   var img = document.getElementsByClassName(blankImageId)[0];
      //   imgInner = img.childNodes[1];
      //   imgInner.style.transform = "translate(-450px, -450px)";
      //   message = document.getElementById("message");
      //   message.innerHTML = "";
      // }

      // plotting random image and still checking is it win and still move component one by one
      function draw(imageObject) {
        imageObject.moves++;
        // console.log(`solvable kah? ${isSolvable(imageObject.imgArr)}`)
        // console.log("hello", moves);
        mov = document.getElementById(imageObject.moveId);
        mov.innerHTML = "MOVES: " + imageObject.moves.toString();
        let isDiff;
        isDiff = 0;

        for (var i = 0; i < 9; i++) {
          if (imageObject.imgArr[i] != normArr[i]) isDiff = 1;
        }
        // console.log(`diff position ${imageObject.imgArr}`);
        // console.log(normArr);

        for (var i = 0; i < 3; i++) {
          for (var j = 0; j < 3; j++) {
            component(i, j, imageObject);
          }
        }

        console.log(isDiff);

        if (isDiff == 0) {
          imageObject.restart = 1;
          won();
        }
      }

      function component(x, y, imageObject) {
        let text = imageObject.identifier;
        let indexArr = x + 3 * y;
        let imgPart = imageObject.imgArr[indexArr];
        text = text + imgPart.toString();
        let img = document.getElementsByClassName(text)[0];
        // console.log(`textnya ${text}`,img);
        img.style.left = 150 * x + "px";
        img.style.top = 150 * y + "px";
      }

      function moveup(imageObject) {
        console.log(`ke atas ${imageObject.emptyPos}`);
        if (
          imageObject.emptyPos == 9 ||
          imageObject.emptyPos == 7 ||
          imageObject.emptyPos == 8
        ) {
          au = document.getElementById("no");
          au.play();
        } else {
          au = document.getElementById("cut");
          au.play();
          let curr = imageObject.emptyPos;
          imageObject.emptyPos = imageObject.emptyPos + 3;
          let next = imageObject.emptyPos;
          imageObject.imgArr[curr - 1] = imageObject.imgArr[next - 1];
          imageObject.imgArr[next - 1] = 8;
          draw(imageObject);
        }
        console.log(imageObject.emptyPos);
      }

      function movedown(imageObject) {
        if (
          imageObject.emptyPos == 1 ||
          imageObject.emptyPos == 2 ||
          imageObject.emptyPos == 3
        ) {
          au = document.getElementById("no");
          au.play();
        } else {
          au = document.getElementById("cut");
          au.play();
          let curr = imageObject.emptyPos;
          imageObject.emptyPos = imageObject.emptyPos - 3;
          let next = imageObject.emptyPos;
          imageObject.imgArr[curr - 1] = imageObject.imgArr[next - 1];
          imageObject.imgArr[next - 1] = 8;
          draw(imageObject);
        }
        console.log(imageObject.emptyPos);
      }

      function moveleft(imageObject) {
        if (
          imageObject.emptyPos == 6 ||
          imageObject.emptyPos == 9 ||
          imageObject.emptyPos == 3
        ) {
          au = document.getElementById("no");
          au.play();
        } else {
          au = document.getElementById("cut");
          au.play();
          let curr = imageObject.emptyPos;
          imageObject.emptyPos = imageObject.emptyPos + 1;
          let next = imageObject.emptyPos;
          imageObject.imgArr[curr - 1] = imageObject.imgArr[next - 1];
          imageObject.imgArr[next - 1] = 8;
          draw(imageObject);
        }
        console.log(imageObject.emptyPos);
      }

      function moveright(imageObject) {
        if (
          imageObject.emptyPos == 1 ||
          imageObject.emptyPos == 4 ||
          imageObject.emptyPos == 7
        ) {
          au = document.getElementById("no");
          au.play();
        } else {
          au = document.getElementById("cut");
          au.play();
          let curr = imageObject.emptyPos;
          imageObject.emptyPos = imageObject.emptyPos - 1;
          let next = imageObject.emptyPos;
          imageObject.imgArr[curr - 1] = imageObject.imgArr[next - 1];
          imageObject.imgArr[next - 1] = 8;
          draw(imageObject);
        }
        console.log(imageObject.emptyPos);
      }

      //program start
      function start() {
        console.log("Mulai");
        let tempShuffledArr = shuffle([...normArr]);
        // test case: [1,7,6,8,3,2,4,0,5]
        imgObject.imgArr = tempShuffledArr;
        imgObjectAI.imgArr = tempShuffledArr;
        for (var i = 0; i <= 8; i++) {
          if (imgObject.imgArr[i] == 8) {
            imgObject.emptyPos = i + 1;
            imgObjectAI.emptyPos = i + 1;
          }
        }
        // console.log(`Ini mulai ${imgObject.imgArr} \n ${tempShuffledArr}`)
        window.addEventListener("keydown", addGameControl);
        showMessage(imgObject.messageId, "");
        showMessage(imgObjectAI.messageId, "");
        showLastPicture(imgObject.zeroPictureId, 300, 300, -450, -450);
        showLastPicture(imgObjectAI.zeroPictureId, 300, 300, -450, -450);
        imgObject.moves = -1;
        imgObjectAI.moves = -1;
        imgObject.restart = 0;
        imgObjectAI.restart = 0;
        draw(imgObject);
        draw(imgObjectAI);
      }

      window.addEventListener("keydown", function (e) {
        key = e.which;
        if (key == 83) {
          e.preventDefault();
          start();
        }
        if (key == 65) {
          e.preventDefault();
          searchValueWithAI(imgObjectAI);
        }
      });

      function addGameControl(e) {
        key = e.which;
        if (key == 37) {
          e.preventDefault();
          moveleft(imgObject);
        }
        if (key == 38) {
          e.preventDefault();
          console.log("up");
          moveup(imgObject);
        }
        if (key == 39) {
          e.preventDefault();
          moveright(imgObject);
        }
        if (key == 40) {
          e.preventDefault();
          movedown(imgObject);
        }
      }

      async function searchValueWithAI(imageObject) {
        let tempShuffled = imageObject.imgArr;
        let result = await search(imgObjectAI);
        imgObjectAI.imgArr = tempShuffled;
        draw(imgObjectAI);
        imgObjectAI.moves = -1;
        await sleep(3000);
        console.log(`HASILNYA ADALAH`, result, result.pathCost, imgObjectAI);
        runSolution(result, imgObjectAI, result.pathCost);
      }

      function runSolution(goalState, imageObject) {
        if (goalState == null) {
          return;
        } else {
          runSolution(goalState.previous, imageObject);
          setTimeout(function () {
            if (imageObject.restart != 1) {
              imageObject.imgArr = goalState.tiles;
              draw(imageObject);
            }
          }, 200 * goalState.pathCost);
        }
      }

      // ctx.font = "30px Arial";
      // ctx.fillText("Hit S to start the game", 80, 210);
    </script>
  </body>
</html>
